fixes/29 with a few backported pieces from upstream.


